///// Setup
# https://www.youtube.com/watch?v=ybvwikNlx9I&t=946s

//// Todo
# setup secure boot (https://wiki.archlinux.org/title/Installation_guide#Boot_the_live_environment)


//// Base
cat /sys/firmware/efi/fw_platform_size (should return 64-bit)
iwctl station wlan0 connet-hidden <ssid>

timedatectl set-ntp true
timedatectl set-timezone <time_zone>

fdisk /dev/<disk>
	# Boot
	n
		FirstSector: <empty>
		LastSector: +1G
	t
		1	(EFI)

	
	# Core
	n
		FirstSector: <empty>
		LastSector: <empty>
	t
		44

	w


cryptsetup luksFormat --type luks2 -y -v --cipher aes-xts-plain64 -s 512 --iter-time 2500 --pbkdf argon2id --pbkdf-memory 1048576 --pbkdf-parallel 4 /dev/<core_partition>
cryptsetup luksOpen /dev/<core_partition> core
# cryptsetup luksDump /dev/vga/lva1
# cryptsetup benchmark

pvcreate /dev/mapper/core
vg create vg /dev/mapper/core
lvcreate -L 8G -n swap vg
lvcreate -l +100%FREE -n core vg

mkfs.fat -F 32 /dev/<boot_partition>
mkfs.ext4 /dev/vg/core
mkswap /dev/vg/swap
swapon /dev/vg/swap

mount /dev/vg/core /mnt
mount --mkdir /dev/<boot_partition> /mnt/boot
mount --mkdir /dev/<efi_partition> /mnt/boot/efi (/mnt/efi)


# Packages
mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.bak
reflector --sort rate --country 'Iran,' --protocl https --age 168 --save /etc/pacman.d/mirrorlist

vim /etc/pacman.conf
	ParallelDownloads = 24
pacstrap -K /mnt base base-devel linux linux-firmware amd-ucode grub efibootmgr man-db netoworkmanager lvm2 os-prober git vim tmux firefox openssh


genfstab -U /mnt >> /mnt/etc/fstab
arch-chroot /mnt


# Enabling zram
echo 'zram' > /etc/modules-load.d/zram.conf
echo 'ACTION=="add", KERNEL=="zram0", ATTR{initstate}=="0", ATTR{comp_algorithm}="zstd", ATTR{disksize}="8G", TAG+="systemd"' > /etc/udev/rules.d/99-zram.rules
echo '/dev/zram0 none swap defaults,discard,pri=100,x-systemd.makefs 0 0' >> /etc/fstab
# add as kernel parameter zswap.enabled=0


# Configs
systemctl enable NetworkManager

ln -sf /usr/share/zoneinfo/Asia/Tehran /etc/localtime
hwclock --systohc

vim /etc/locale.gen
	!# en_US.UTF-8 UTF-8
locale-gen
echo "LANG=en_US.UTF-8" >> /etc/locale.conf

echo "<host_name>" >> /etc/hostname
vim /etc/hosts
	127.0.0.1	localhost
	::1			localhost



# Initramfs
vim /etc/mkinitcpio.conf
	HOOKS=(base udev autodetect keyboard modconf block encrypt lvm2 filesystems fsck)
mkinitcpio -P



# Grub
blkid -o value -s UUID </dev/core_partition> >> /etc/default/grub

vim /etc/default/grub
	GRUB_TIMEOUT=1
	GRUB_CMDLINE_LINUX_DEFAULT="cryptdevice=UUID=</dev/core_partition_UUID>:core root=/dev/mapper/core"
	GRUB_DISABLE_OS_PROBER=false

grub-install (--target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB)
grub-mkconfig -o /boot/grub/grub.cfg
#os-prober


passwd
useradd -m -G wheel -s /bin/bash <username>
passwd <username>
vim /etc/sudoers (wheel)
exit

umount -R /mnt
reboot



//// GUI
/// Display Servers
// Xorg
pacman -S xorg-server

// Wayland


/// Display Drivers
// Amd
pacman -S mesa libva-mesa-driver


// Intel
pacman -S mesa intel-media-driver


// Nvidia
# https://wiki.archlinux.org/title/NVIDIA
pacman -S nvidia nvidia-utils
lspci -k | grep -A 2 -E "(VGA|3D)"


// Tune
# limit Power,GPU Clock - PS-0 (GPU +<target> - VRAM +<target * 2>) Offset
pacman -S lact mangohud goverlay (lib23-mangohud)

mangohud vkcube
mangohud glxgears



//// Desktop Environment
/// KDE
pacman -S sddm plasma-meta kde-applications-meta kscreen
systemctl enable sddm --now



/// Xfce
pacman -S xorg xfce4 xfce4-goodies (lightdm ,lightdm-gtk-greeter ,lightdm.service)



/// Hyperland
# https://www.youtube.com/watch?v=iE99GrcZzhs






//// Troubleshoot
wifi-menu
cryptsetup luksOpen /dev/<core_partition> core

mount /dev/vg/core /mnt
mount /dev/<boot_partition> /mnt/boot
mount /dev/<efi_partition> /mnt/boot/efi
arch-chroot /mnt

unmount -R /mnt
